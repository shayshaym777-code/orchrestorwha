# 🏗️ שרת הדוקר - ארכיטקטורה

---

## דיאגרמה כללית

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           DOCKER SESSION SERVER                                  │
│                              (VPS / Cloud)                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         DOCKER COMPOSE STACK                             │   │
│   │                     Network: 172.28.0.0/16                               │   │
│   ├─────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                          │   │
│   │  ┌─────────────┐     ┌─────────────────────────────────────────────┐    │   │
│   │  │             │     │           ORCHESTRATOR (172.28.0.3)          │    │   │
│   │  │    REDIS    │     │                                              │    │   │
│   │  │ (172.28.0.2)│     │  ┌────────────────────────────────────────┐ │    │   │
│   │  │             │◄────┤  │           Express Server               │ │    │   │
│   │  │  ┌───────┐  │     │  │              Port 3000                 │ │    │   │
│   │  │  │Sessions│  │     │  └────────────────────────────────────────┘ │    │   │
│   │  │  │Proxies │  │     │                     │                       │    │   │
│   │  │  │Locks  │  │     │  ┌──────────────────┼──────────────────┐   │    │   │
│   │  │  └───────┘  │     │  │                  │                  │   │    │   │
│   │  │             │     │  ▼                  ▼                  ▼   │    │   │
│   │  │   Port 6379 │     │ ┌─────────┐  ┌───────────┐  ┌──────────┐  │    │   │
│   │  └─────────────┘     │ │ Session │  │  Proxy    │  │ Watchdog │  │    │   │
│   │                       │ │ Service │  │  Pool     │  │ Service  │  │    │   │
│   │                       │ └─────────┘  └───────────┘  └──────────┘  │    │   │
│   │                       │      │             │              │        │    │   │
│   │                       │      └─────────────┴──────────────┘        │    │   │
│   │                       │                    │                       │    │   │
│   │                       │                    ▼                       │    │   │
│   │                       │         ┌──────────────────┐              │    │   │
│   │                       │         │  Runner Service  │              │    │   │
│   │                       │         │ (Docker Control) │              │    │   │
│   │                       │         └────────┬─────────┘              │    │   │
│   │                       └──────────────────┼────────────────────────┘    │   │
│   │                                          │                             │   │
│   │                                          │ docker run / stop           │   │
│   │                                          ▼                             │   │
│   │  ┌─────────────────────────────────────────────────────────────────┐  │   │
│   │  │                        WORKERS (Dynamic)                         │  │   │
│   │  │                                                                  │  │   │
│   │  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐           │  │   │
│   │  │   │  Worker 1   │   │  Worker 2   │   │  Worker 3   │   ...     │  │   │
│   │  │   │ 172.28.0.10 │   │ 172.28.0.11 │   │ 172.28.0.12 │           │  │   │
│   │  │   │             │   │             │   │             │           │  │   │
│   │  │   │ ┌─────────┐ │   │ ┌─────────┐ │   │ ┌─────────┐ │           │  │   │
│   │  │   │ │ Baileys │ │   │ │ Baileys │ │   │ │ Baileys │ │           │  │   │
│   │  │   │ │ Library │ │   │ │ Library │ │   │ │ Library │ │           │  │   │
│   │  │   │ └────┬────┘ │   │ └────┬────┘ │   │ └────┬────┘ │           │  │   │
│   │  │   │      │      │   │      │      │   │      │      │           │  │   │
│   │  │   │      ▼      │   │      ▼      │   │      ▼      │           │  │   │
│   │  │   │  ┌──────┐   │   │  ┌──────┐   │   │  ┌──────┐   │           │  │   │
│   │  │   │  │Proxy │   │   │  │Proxy │   │   │  │Proxy │   │           │  │   │
│   │  │   │  │  A   │   │   │  │  B   │   │   │  │  A   │   │           │  │   │
│   │  │   │  └──┬───┘   │   │  └──┬───┘   │   │  └──┬───┘   │           │  │   │
│   │  │   └─────┼───────┘   └─────┼───────┘   └─────┼───────┘           │  │   │
│   │  │         │                 │                 │                   │  │   │
│   │  └─────────┼─────────────────┼─────────────────┼───────────────────┘  │   │
│   │            │                 │                 │                      │   │
│   └────────────┼─────────────────┼─────────────────┼──────────────────────┘   │
│                │                 │                 │                          │
│                └────────────┬────┴─────────────────┘                          │
│                             │                                                  │
│                             ▼                                                  │
│                    ┌─────────────────┐                                        │
│                    │    WhatsApp     │                                        │
│                    │    Servers      │                                        │
│                    │    (Meta)       │                                        │
│                    └─────────────────┘                                        │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## Proxy Sticky IP System

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          PROXY STICKY IP                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   PHONE NUMBERS              BINDING                    PROXY POOL       │
│   ─────────────              ───────                    ──────────       │
│                                                                          │
│   ┌─────────────┐                                    ┌─────────────┐    │
│   │ 972501111111│─────────────────────────────────►  │  PROXY A    │    │
│   └─────────────┘                                    │  ┌───┬───┐  │    │
│   ┌─────────────┐                                    │  │ 1 │ 3 │  │    │
│   │ 972503333333│─────────────────────────────────►  │  └───┴───┘  │    │
│   └─────────────┘                                    │  Count: 2   │    │
│                                                      └─────────────┘    │
│                                                                          │
│   ┌─────────────┐                                    ┌─────────────┐    │
│   │ 972502222222│─────────────────────────────────►  │  PROXY B    │    │
│   └─────────────┘                                    │  ┌───┐      │    │
│                                                      │  │ 2 │      │    │
│                                                      │  └───┘      │    │
│                                                      │  Count: 1   │    │
│                                                      └─────────────┘    │
│                                                                          │
│   ┌─────────────┐                                    ┌─────────────┐    │
│   │ 972504444444│─────────────────────────────────►  │  PROXY C    │    │
│   │ 972505555555│─────────────────────────────────►  │  ┌───┬───┐  │    │
│   │ 972506666666│─────────────────────────────────►  │  │ 4 │ 5 │  │    │
│   │ 972507777777│─────────────────────────────────►  │  ├───┼───┤  │    │
│   └─────────────┘                                    │  │ 6 │ 7 │  │    │
│                                                      │  └───┴───┘  │    │
│                                                      │  Count: 4   │    │
│                                                      │  ⚠️ FULL!   │    │
│                                                      └─────────────┘    │
│                                                                          │
│   ┌─────────────┐         C is full,                 ┌─────────────┐    │
│   │ 972508888888│─────── select D ─────────────────► │  PROXY D    │    │
│   └─────────────┘                                    │  ┌───┐      │    │
│                                                      │  │ 8 │      │    │
│                                                      │  └───┘      │    │
│                                                      │  Count: 1   │    │
│                                                      └─────────────┘    │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                           RULES                                  │   │
│   │  • Same phone → Always same proxy (Sticky IP)                   │   │
│   │  • Max 4 sessions per proxy                                     │   │
│   │  • New phone → Select available proxy (count < 4)               │   │
│   │  • Proxy error → Mark BAD, switch to new                        │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Worker Internal Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           WORKER CONTAINER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ENV Variables:                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  SESSION_ID = "worker_1"                                         │   │
│   │  PROXY_URL = "socks5h://user:pass@host:port"                     │   │
│   │  WEBHOOK_URL = "http://172.28.0.3:3000/webhook"                  │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                      Baileys Library                             │   │
│   │                                                                  │   │
│   │   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │   │
│   │   │   Socket     │    │    Auth      │    │   Events     │      │   │
│   │   │  Connection  │    │   State      │    │   Handler    │      │   │
│   │   └──────┬───────┘    └──────┬───────┘    └──────┬───────┘      │   │
│   │          │                   │                   │               │   │
│   │          └───────────────────┴───────────────────┘               │   │
│   │                              │                                    │   │
│   └──────────────────────────────┼──────────────────────────────────┘   │
│                                  │                                       │
│   ┌──────────────────────────────┼──────────────────────────────────┐   │
│   │                     PROXY AGENT                                  │   │
│   │                                                                  │   │
│   │    const agent = new SocksProxyAgent(PROXY_URL);                │   │
│   │    // All traffic goes through proxy                             │   │
│   │                                                                  │   │
│   └──────────────────────────────┼──────────────────────────────────┘   │
│                                  │                                       │
│   ┌──────────────────────────────┼──────────────────────────────────┐   │
│   │                    KEEP-ALIVE ENGINE                             │   │
│   │                                                                  │   │
│   │    ┌─────────────────┐    ┌─────────────────────────────────┐   │   │
│   │    │ Every 15 sec    │    │ Every 10 min                     │   │   │
│   │    │ Presence Update │    │ Hidden Message to Self           │   │   │
│   │    │ "available"     │    │ {text: "🔄", ephemeral: 24h}     │   │   │
│   │    └─────────────────┘    └─────────────────────────────────┘   │   │
│   │                                                                  │   │
│   └──────────────────────────────┼──────────────────────────────────┘   │
│                                  │                                       │
│   ┌──────────────────────────────┼──────────────────────────────────┐   │
│   │                    WEBHOOK REPORTER                              │   │
│   │                                                                  │   │
│   │    Events → POST to Orchestrator:                               │   │
│   │    • QR_CODE                                                     │   │
│   │    • CONNECTED                                                   │   │
│   │    • DISCONNECTED                                                │   │
│   │    • PING                                                        │   │
│   │    • PROXY_ERROR                                                 │   │
│   │                                                                  │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   Volume Mount:                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  /app/session → sessions/worker_1/                              │   │
│   │  Contains: creds.json, keys, state                              │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Webhook Communication

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          WEBHOOK FLOW                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   WORKER                              ORCHESTRATOR                       │
│   ──────                              ────────────                       │
│                                                                          │
│   ┌─────────────┐                                                       │
│   │  Event      │     POST /webhook                                     │
│   │  Occurs     │─────────────────────────────►┌─────────────┐         │
│   └─────────────┘     {                        │  Webhook    │         │
│                         sessionId,             │  Handler    │         │
│                         type,                  └──────┬──────┘         │
│                         data,                        │                 │
│                         timestamp                    │                 │
│                       }                              ▼                 │
│                                             ┌─────────────────┐        │
│                                             │  Switch by Type │        │
│                                             └────────┬────────┘        │
│                                                      │                 │
│                             ┌─────────────────┬──────┴──────┐          │
│                             │                 │             │          │
│                             ▼                 ▼             ▼          │
│                    ┌─────────────┐   ┌─────────────┐ ┌───────────┐    │
│                    │  QR_CODE    │   │  CONNECTED  │ │ DISCONNECT│    │
│                    │             │   │             │ │           │    │
│                    │ • Save QR   │   │ • Sticky IP │ │ • Check   │    │
│                    │ • Broadcast │   │ • Update    │ │   reason  │    │
│                    │ • Status    │   │   status    │ │ • Restart │    │
│                    │   qr_ready  │   │ • Alert ✅  │ │   or mark │    │
│                    └─────────────┘   └─────────────┘ └───────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

