<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OBS QR Display</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: transparent; /* ×©×§×•×£ ×œ-OBS */
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: linear-gradient(145deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      border-radius: 24px;
      padding: 30px;
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.5),
        0 0 100px rgba(37, 211, 102, 0.1);
      border: 2px solid rgba(37, 211, 102, 0.3);
      text-align: center;
      min-width: 380px;
    }
    
    .header {
      margin-bottom: 20px;
    }
    
    .header h1 {
      color: #25D366;
      font-size: 28px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .header .subtitle {
      color: #8892b0;
      font-size: 14px;
    }
    
    .qr-frame {
      background: white;
      border-radius: 20px;
      padding: 20px;
      margin: 20px auto;
      width: 280px;
      height: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .qr-frame::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        transparent 40%,
        rgba(37, 211, 102, 0.1) 50%,
        transparent 60%
      );
      animation: shine 3s infinite;
    }
    
    @keyframes shine {
      0% { transform: translateX(-100%) rotate(45deg); }
      100% { transform: translateX(100%) rotate(45deg); }
    }
    
    #qr-image {
      max-width: 240px;
      max-height: 240px;
      border-radius: 10px;
      position: relative;
      z-index: 1;
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      color: #666;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #e0e0e0;
      border-top-color: #25D366;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      font-size: 16px;
    }
    
    .status.waiting {
      background: rgba(255, 193, 7, 0.1);
      color: #FFC107;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .status.ready {
      background: rgba(37, 211, 102, 0.1);
      color: #25D366;
      border: 1px solid rgba(37, 211, 102, 0.3);
    }
    
    .status.connected {
      background: rgba(33, 150, 243, 0.1);
      color: #2196F3;
      border: 1px solid rgba(33, 150, 243, 0.3);
    }
    
    .status.error {
      background: rgba(244, 67, 54, 0.1);
      color: #F44336;
      border: 1px solid rgba(244, 67, 54, 0.3);
    }
    
    .session-info {
      margin-top: 15px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: 13px;
      color: #8892b0;
    }
    
    .session-info .label {
      color: #64ffda;
    }
    
    .phone-display {
      font-size: 22px;
      font-weight: bold;
      color: #fff;
      margin-top: 10px;
      font-family: monospace;
      letter-spacing: 2px;
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }
    
    .btn-primary {
      background: #25D366;
      color: white;
    }
    
    .btn-primary:hover {
      background: #128C7E;
      transform: scale(1.05);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .footer {
      margin-top: 20px;
      font-size: 11px;
      color: #5a6270;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“± WhatsApp QR</h1>
      <div class="subtitle">×¡×¨×•×§ ×›×“×™ ×œ×”×ª×—×‘×¨</div>
    </div>
    
    <div class="qr-frame">
      <div id="qr-content">
        <div class="loading">
          <div class="spinner"></div>
          <div>××™×™×¦×¨ ×¡×©×Ÿ ×—×“×©...</div>
        </div>
      </div>
    </div>
    
    <div id="status" class="status waiting">
      â³ ×××ª×™×Ÿ ×œ×™×¦×™×¨×ª ×¡×©×Ÿ...
    </div>
    
    <div id="session-info" class="session-info" style="display: none;">
      <span class="label">Session:</span> <span id="session-id">-</span><br>
      <div id="phone-container" style="display: none;">
        <span class="label">Phone:</span>
        <div id="phone-number" class="phone-display">-</div>
      </div>
    </div>
    
    <div class="controls">
      <button class="btn btn-primary" onclick="createNewSession()">ğŸ”„ ×¡×©×Ÿ ×—×“×©</button>
      <button class="btn btn-secondary" onclick="refreshQR()">â†» ×¨×¢× ×Ÿ QR</button>
    </div>
    
    <div class="footer">
      OBS Display Mode | Auto-refresh enabled
    </div>
  </div>

  <script>
    // ×§×¨× API Key ×-URL ××• localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const API_KEY = urlParams.get('key') || localStorage.getItem('wa_api_key') || 'test-key';
    
    let currentSessionId = urlParams.get('session') || null;
    let pollInterval = null;
    let isCreatingSession = false;
    
    // ××ª×—×•×œ
    document.addEventListener('DOMContentLoaded', () => {
      if (currentSessionId) {
        // ×™×© ×¡×©×Ÿ ×¡×¤×¦×™×¤×™ - ×¢×§×•×‘ ××—×¨×™×•
        startPolling(currentSessionId);
      } else {
        // ×¦×•×¨ ×¡×©×Ÿ ×—×“×© ××•×˜×•××˜×™×ª
        createNewSession();
      }
    });
    
    // ×™×¦×™×¨×ª ×¡×©×Ÿ ×—×“×©
    async function createNewSession() {
      if (isCreatingSession) return;
      isCreatingSession = true;
      
      updateStatus('waiting', 'â³ ×™×•×¦×¨ ×¡×©×Ÿ ×—×“×©...');
      showLoading();
      
      try {
        const response = await fetch('/api/sessions/provision', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-KEY': API_KEY
          },
          body: JSON.stringify({
            // ×œ×œ× phone - ×™×§×‘×œ ×××ª×™×Ÿ ×œ×¡×¨×™×§×”
          })
        });
        
        const data = await response.json();
        
        if (data.sessionId) {
          currentSessionId = data.sessionId;
          document.getElementById('session-id').textContent = currentSessionId;
          document.getElementById('session-info').style.display = 'block';
          
          updateStatus('ready', 'âœ… ×¡×©×Ÿ × ×•×¦×¨! ×××ª×™×Ÿ ×œ-QR...');
          startPolling(currentSessionId);
        } else if (data.error || data.reason) {
          throw new Error(data.reason || data.error || 'Failed to create session');
        }
      } catch (err) {
        console.error('Create session error:', err);
        updateStatus('error', `âŒ ×©×’×™××”: ${err.message}`);
        
        // × ×¡×” ×©×•×‘ ××—×¨×™ 5 ×©× ×™×•×ª
        setTimeout(() => {
          isCreatingSession = false;
          createNewSession();
        }, 5000);
      }
      
      isCreatingSession = false;
    }
    
    // ×”×ª×—×œ ×œ×¢×§×•×‘ ××—×¨×™ QR
    function startPolling(sessionId) {
      if (pollInterval) clearInterval(pollInterval);
      
      // ×‘×“×•×§ ××™×“
      checkQR(sessionId);
      
      // ×‘×“×•×§ ×›×œ 2 ×©× ×™×•×ª
      pollInterval = setInterval(() => checkQR(sessionId), 2000);
    }
    
    // ×‘×“×™×§×ª QR
    async function checkQR(sessionId) {
      try {
        const response = await fetch(`/api/sessions/${sessionId}/qr`, {
          headers: { 'X-API-KEY': API_KEY }
        });
        
        const data = await response.json();
        
        if (data.qr) {
          // ×™×© QR - ×”×¦×’ ××•×ª×•
          showQR(data.qr);
          updateStatus('ready', 'ğŸ“± ×¡×¨×•×§ ××ª ×”×§×•×“ ×œ×”×ª×—×‘×¨×•×ª');
        } else if (data.status === 'CONNECTED' || data.connected) {
          // ××—×•×‘×¨!
          showConnected(data.phone || data.phoneNumber);
        } else if (data.status === 'PENDING' || data.status === 'pending') {
          updateStatus('waiting', 'â³ ×××ª×™×Ÿ ×œ-QR ××”×©×¨×ª...');
        } else {
          // ×‘×“×•×§ ×¡×˜×˜×•×¡ ×¡×©×Ÿ
          checkSessionStatus(sessionId);
        }
      } catch (err) {
        console.error('QR check error:', err);
      }
    }
    
    // ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×¡×©×Ÿ
    async function checkSessionStatus(sessionId) {
      try {
        const response = await fetch(`/api/v1/dashboard/sessions`, {
          headers: { 'X-API-KEY': API_KEY }
        });
        
        const data = await response.json();
        
        if (data.data) {
          const sessions = Object.values(data.data);
          const session = sessions.find(s => s.sessionId === sessionId);
          
          if (session) {
            if (session.status === 'CONNECTED') {
              showConnected(session.phone);
            } else if (session.qr) {
              showQR(session.qr);
              updateStatus('ready', 'ğŸ“± ×¡×¨×•×§ ××ª ×”×§×•×“ ×œ×”×ª×—×‘×¨×•×ª');
            }
          }
        }
      } catch (err) {
        console.error('Status check error:', err);
      }
    }
    
    // ×”×¦×’×ª QR
    function showQR(qrData) {
      const qrContent = document.getElementById('qr-content');
      
      // ×× ×–×” ×›×‘×¨ base64 image
      if (qrData.startsWith('data:image')) {
        qrContent.innerHTML = `<img id="qr-image" src="${qrData}" alt="QR Code">`;
      } else {
        // × ×¡×” ×œ×”×¦×™×’ ×›×ª××•× ×” ×-URL ××• base64
        qrContent.innerHTML = `<img id="qr-image" src="${qrData}" alt="QR Code" onerror="generateQRImage('${qrData}')">`;
      }
    }
    
    // ×™×¦×™×¨×ª ×ª××•× ×ª QR ××˜×§×¡×˜
    function generateQRImage(text) {
      // Fallback - ×”×¦×’ ×˜×§×¡×˜ ×©×œ ×”-QR
      const qrContent = document.getElementById('qr-content');
      qrContent.innerHTML = `
        <div style="padding: 20px; background: #f0f0f0; border-radius: 10px; word-break: break-all; font-size: 10px; max-width: 200px;">
          ${text.substring(0, 100)}...
        </div>
      `;
    }
    
    // ×”×¦×’×ª ××¦×‘ ××—×•×‘×¨
    function showConnected(phone) {
      const qrContent = document.getElementById('qr-content');
      qrContent.innerHTML = `
        <div style="text-align: center; color: #25D366;">
          <div style="font-size: 80px; margin-bottom: 10px;">âœ…</div>
          <div style="font-size: 18px; font-weight: bold;">××—×•×‘×¨!</div>
        </div>
      `;
      
      updateStatus('connected', 'ğŸŸ¢ WhatsApp ××—×•×‘×¨!');
      
      if (phone) {
        document.getElementById('phone-container').style.display = 'block';
        document.getElementById('phone-number').textContent = phone;
      }
      
      // ×¢×¦×•×¨ polling
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
      
      // ××—×¨×™ 10 ×©× ×™×•×ª - ×¦×•×¨ ×¡×©×Ÿ ×—×“×© ××•×˜×•××˜×™×ª
      setTimeout(() => {
        createNewSession();
      }, 10000);
    }
    
    // ×”×¦×’×ª ×˜×¢×™× ×”
    function showLoading() {
      const qrContent = document.getElementById('qr-content');
      qrContent.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>××™×™×¦×¨ ×¡×©×Ÿ...</div>
        </div>
      `;
    }
    
    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
    function updateStatus(type, message) {
      const status = document.getElementById('status');
      status.className = `status ${type}`;
      status.innerHTML = message;
    }
    
    // ×¨×¢× ×•×Ÿ QR
    function refreshQR() {
      if (currentSessionId) {
        checkQR(currentSessionId);
      } else {
        createNewSession();
      }
    }
  </script>
</body>
</html>

